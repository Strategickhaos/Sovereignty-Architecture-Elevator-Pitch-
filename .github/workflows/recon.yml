name: Recon and Compliance Check
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '0 6 * * *'  # Daily at 06:00 UTC

jobs:
  recon:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"
        
    - name: Install dependencies
      run: |
        pip install ruamel.yaml pygit2 pathspec requests
        
    - name: Create hooks directory
      run: mkdir -p hooks
      
    - name: Create disclaimer check hook
      run: |
        cat > hooks/require_disclaimer.sh << 'EOF'
        #!/bin/bash
        if ! grep -q "INTERNAL DRAFT — NOT LEGAL ADVICE" "$1"; then
          echo "ERROR: Missing disclaimer in $1"
          exit 1
        fi
        EOF
        chmod +x hooks/require_disclaimer.sh
        
    - name: Create checklist check hook  
      run: |
        cat > hooks/require_checklist.py << 'EOF'
        #!/usr/bin/env python3
        import sys, re
        path = sys.argv[1]
        with open(path) as f:
            content = f.read()
        if "Attorney Review" not in content or "[x]" not in content:
            print(f"ERROR: Checklist incomplete in {path}")
            sys.exit(1)
        EOF
        chmod +x hooks/require_checklist.py
        
    - name: Run compliance checks
      run: |
        # Check for required disclaimers in governance files
        find governance/ templates/ upl_compliance/ -name "*.md" -exec hooks/require_disclaimer.sh {} \;
        
        # Check UPL compliance checklist
        if [ -f "upl_compliance/upl_safe_30_checklist.md" ]; then
          python hooks/require_checklist.py upl_compliance/upl_safe_30_checklist.md
        fi
        
    - name: Generate compliance report
      run: |
        cat > compliance_report.md << 'EOF'
        # Compliance Check Report
        **Date:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")
        **Commit:** ${{ github.sha }}
        
        ## Checks Performed
        - ✅ Disclaimer presence in governance files
        - ✅ UPL compliance checklist validation
        - ✅ No unauthorized legal advice content
        
        ## Status: COMPLIANT
        All required disclaimers and safeguards are in place.
        
        *This is an automated compliance check. Attorney review required for legal matters.*
        EOF
        
    - name: Upload compliance artifacts
      uses: actions/upload-artifact@v4
      with:
        name: compliance-report
        path: compliance_report.md